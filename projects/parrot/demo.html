<!DOCTYPE html>
<html>

<head>
</head>

<body>
    <button onclick="javascript:loadVoices()">Load</button>
    <script>
        console.log("Test");
        final_transcript = '';
        recognition = null;
        voice = null;
        
        function loadVoices() {
            Log('loading voices')

            const voices = speechSynthesis.getVoices()
            if (voices.length > 0) {
                voice = window.speechSynthesis.getVoices().find(v=>v.lang.toLowerCase()=='en-us');
                Log("Voice Found: "+voice.voiceURI);
                SetupS2T();
            }

            setTimeout(() => loadVoices, 1000)
        }

        function SetupS2T() {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = "en-us";
            ignore_onend = false;

            recognition.onstart = function () {
                recognizing = true;
                console.log("S2T start");
            };

            recognition.onerror = function (event) {
                console.log("S2T error:");
                console.log(event);
                ignore_onend = true;
            };

            recognition.onend = function () {
                recognizing = false;
                if (ignore_onend) {
                    return;
                }
                console.log("S2T end")
            };

            recognition.onresult = function (event) {
                var interim_transcript = '';
                if (typeof (event.results) == 'undefined') {
                    recognition.onend = null;
                    recognition.stop();
                    Log("S2T: On results error?");
                    return;
                }
                
                for (var i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        final_transcript += event.results[i][0].transcript;
                    } else {
                        interim_transcript += event.results[i][0].transcript;
                    }
                }
                if( interim_transcript == '' ) {
                    console.log("S2T Final Transcript: " + final_transcript)
                    BirdSpeak(final_transcript);
                    final_transcript = '';
                } else {
                    Log("S2T Interim Transcript: " + interim_transcript)
                }
            };

            recognition.start();
        }


        function Croak() {
            let utterance = new SpeechSynthesisUtterance("Rocccckkk! Rocccckkk!");
            utterance.volume = 50;
            utterance.pitch = 100;
            utterance.rate = 1.25;
        }

        function handleSpeechEvent(e) {
            Log(JSON.stringify(e));
        }

        function MakeUtterance(str) {
            let utterance = new SpeechSynthesisUtterance(str);
            utterance.volume = 50;
            utterance.pitch = 100;
            utterance.rate = 1.25;
            utterance.voice = voice;
            utterance.addEventListener('start', handleSpeechEvent);
            utterance.addEventListener('end', handleSpeechEvent);
            utterance.addEventListener('error', handleSpeechEvent);
            utterance.addEventListener('boundary', handleSpeechEvent);
            utterance.addEventListener('pause', handleSpeechEvent);
            utterance.addEventListener('resume', handleSpeechEvent);
            speechSynthesis.speak(utterance);
        }

        function BirdSpeak(phrase) {
            var short_phrase = phrase.split(" ").slice(-3).join(" ");
            Log("Phrase: "+short_phrase);

            let utterance = MakeUtterance("Rocccckkk! Rocccckkk!");
            utterance.pitch = 100;
            utterance.rate = 1.25;
            utterance.addEventListener('end', ()=>{
                Speak(short_phrase);
            });
            speechSynthesis.speak(utterance);
        }

        function Speak(phrase) {
            utterance = new MakeUtterance(phrase);
            speechSynthesis.speak(utterance);
        }

        function Log(str) { 
            document.body.innerHTML = str+"<br>"+document.body.innerHTML
        }


    </script>
</body>

</html>